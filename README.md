# Sensitivity Analysis - Postprocessing  

Scripts to perform the postprocessing of sensitivity analysis results obtained with **DAKOTA** and **MAMMA**.  
This repository provides tools to:  
- Extract and organize raw simulation outputs into `csv` files.  
- Generate correlation plots between input parameters and response functions.  
- Generate plot Sobol indices for variance-based sensitivity analysis.  
- (Planned) Extend functionality to frequency plots and other postprocessing tasks.  

## ðŸ“‘ Table of Contents  

1. [Repository Structure](#1-repository-structure)  
2. [Preparation](#2-preparation)  
3. [Data Extraction (`extact_allData.py`)](#3-data-extraction-extract_alldatapy)  
    * [Usage](#usage)
    * [Output](#output)
    * [Customization](#customization)
4. [Correlation Plots (`plot_correlation.py`)](#4-correlation-plots-plot_correlationpy) 
    * [Features](#features)
    * [Required files](#required-files)
    * [Usage](#usage-1)
    * [Output](#output-1)
    * [Customization](#customization-1)
5. [Sobol Indices (`plot_sobol.py`)](#5-sobol-indices-plot_sobolpy)  
    * [Output](#output-2)
    * [Customization](#customization-2)
6. [Notes](#notes)  

##  1. Repository Structure

- **`extract_allData.py`** â†’ Extracts all data from DAKOTA/MAMMA simulations into structured CSV files.  
- **`plot_correlation.py`** â†’ Generates correlation plots between input variables and response functions.  
- **`plot_sobol.py`** â†’ Plots Sobol sensitivity indices.  
- **`my_lib_extract_data.py`** â†’ Library of functions to support `estract_allData.py'.
- **`my_lib_process_utils.py`** â†’ Library of functions that support all the other scripts.

## 2. Preparation 

Make sure the working directory contains the following files:  

- `dakota_tabular.dat`  
- `dakota_test_parallel.in`  
- `conduit_solver.template`  

Additionally, you need a folder containing all the simulation results from the sensitivity analysis.  
A recommended structure is:  

workdir/

â”œâ”€â”€ workdir.1/

â”œâ”€â”€ workdir.2/

â”œâ”€â”€ ...


## 3. Data Extraction (`extract_allData.py`)

### Usage 
Run the extraction script to collect all simulation results into CSV files:  

```bash
python extract_allData.py

```

Optional arguments:

--verbose true/false â†’ Enable detailed logging.

--pause true/false â†’ Pause execution at key steps.

### Output

The script generates 34 CSV files organized by eruptive style (Explosive, Effusive, Fountaining, etc.) and saves them in the `csv_files/` directory.

Examples:

`data_allConcat.csv`

`data_allConcat_explosive.csv`

`data_allConcat_notExplosive.csv`

`data_allConcat_notExplosive_effusive.csv`

`data_allConcat_notExplosive_fountaining.csv`

â€¦ and others.

Each CSV file uses a *two-row header*:
- **level 0:** technical names (`x1`, `response_fn_12`, â€¦)  
- **level 1:** descriptive labels (`Pressure [Pa]`, `Exit velocity [m/s]`, â€¦)

### Customization 

The user can modify the extraction of data, by adding, removing, or modifying response functions. 
* Go to `extract_allData.py` and modify the part where new response functions are created and where the labels are generated.
  Mind that the current setup accounts for 15 response functions generated by DAKOTA outputs and are read from `dakota_tabular.dat`.
* Go to `my_lib_extract_data.py` and modify inside the functions `extract_data_*`:
  * the part related to `response_data['response_fn_*'][index_simul]`
  * the labels `'response_fn_*': "XXX [YYY]"`,


##  4. Correlation Plots (`plot_correlation.py`)

Generate correlation plots between input parameters (x1, x2, â€¦) and response functions (response_fn_*).


### Features
- **File management**  
  - Checks for required input files (see below) in the `csv_files/` folder and in the current working directory. In the latter case, moves them automatically into the `csv_files/` folder.  
  - If missing, runs `extract_allData.py` to generate them.  
- **Data handling**  
  - Reads CSVs with two-row headers into `pandas.DataFrame` objects.  
  - Computes binned statistics (`bin_and_average`) for response functions.  
- **Plotting utilities** (from `my_lib_process_utils.py`):  
  - `plot_xi_vs_response_fn`: plot automatically each `xi` present vs. one response function.  
  - `plot_lists`: plot arbitrary pairs of variables.   
  Each plotting utility supports multiple datasets overlayed in the same figure (e.g., Explosive, Effusive, and Fountaining) or a single dataset only.
  In case that multiple datasets are plotted, each one has a distinct color and - if desidered - a distinct marker style.
  Each plotting utility supports the plot of the mean values *IF* a dictionary `stats` is passed.

### Required files
- **Mandatory**  
  - `dakota_test_parallel.in` (DAKOTA input file containing parameter bounds).  
- **Optional: CSV datasets**  
  - `data_allConcat.csv`  
  - `data_allConcat_explosive.csv`  
  - `data_allConcat_notExplosive.csv`  
  - `data_allConcat_notExplosive_effusive.csv`  
  - `data_allConcat_notExplosive_fountaining.csv`  
  If present, they are loaded as dataFrame, otherwise they are generated by calling `extract_allData.py` and then loaded.

### Usage 
Run from the terminal:

```bash
python plot_correlation.py
```

### Output
* Plots show scatter distributions and binned means for comparison.
* Multiple eruptive regimes (Explosive, Effusive, Fountaining) can be compared on the same plot.
* Saves figures in `.svg` format under `plot_correlations/`.

### Customization

The script can be easily customized to:

* Change the number of bins (`N_bins`) used to compute the statistics with the function `bin_and_average()`.

* The function `utils.plot_xi_vs_response_fn()` is designed to plot the correlation between all the input parameters (without the need to specify them, because it will automatically look for columns with header `xi`) and a response function. The plot function can be customized by modifying its call.
  * `dfs` â†’ dictionary of datasets to compare.
    Example:

    ```python
    dfs = {
      "Explosive": df_concat_expl,
      "Effusive": df_concat_eff,
      "Fountaining": df_concat_fount
    }
    ```
    
    You can remove some regimes, or pass a single DataFrame instead of a dictionary, like:
    ```python
    dfs = {df_concat}
    ```
  * `response_col` â†’ response function to analyze (e.g. `response_fn_1`, `response_fn_15`).
  * **Optional parameters:**
    * `y_label` â†’ Custom label for Y-axis. Default: the descriptive label from the CSV header.
    * `n_step` â†’ Sampling step for scatter plot (useful for large datasets). Default: 3.
    * `save_name` â†’ Filename (without extension) for saving plot. If not present, it is  auto-generated.
    * `save_dir` â†’ Folder to save plots. Default: `plot_correlations`.
    * `stats` â†’ Dictionary from `bin_and_average()`. If provided, mean values are plotted.

  Example of usage:
  ```python
  utils.plot_xi_vs_response_fn(
    dfs={
        "Explosive": df_concat_expl,
        "notExplosive": df_concat_notExpl
    },
    input_Min=input_Min,
    input_Max=input_Max,
    response_col='response_fn_1',
    n_step=2,
    save_name='my_plot',
    save_dir='plots',
    stats=stats
  )
  ```
  If `save_name` is not provided, the function generates a name like `corr_Explosive_notExplosive_xi_response_fn_1`.


* The function `utils.plot_list()` is designed to plot the correlation between arbitrary pairs of variables, defined by two lists. It is very flexible: the user can specify transformations, labels, and multiple datasets to overlay in the same figure.
  * `dfs` â†’ dictionary of datasets to compare.
    Example:

    ```python
    dfs = {
      "Explosive": df_concat_expl,
      "Effusive": df_concat_eff,
      "Fountaining": df_concat_fount
    }
    ```
    
    You can remove some regimes, or pass a single DataFrame instead of a dictionary, like:
    ```python
    dfs = {df_concat}
    ```
  * `x_axis`, `y_axis` â†’ lists of tuples defining what to plot. Each tuple can have up to 3 elements: 
    * `col_name` â†’ column name in the DataFrame (e.g., `'x1'` or `'response_fn_4'`)
    * `transform_or_factor` â†’ (optional) function (e.g., sum, multiplication, log10) applied to the data
    * `label` â†’ () string for axis label

    Example of how to create the two lists:
    ```python
    list_for_x_axis = [
      ("x1", lambda v: v/1e6, "Inlet pressure [MPa]"),
      ("x2", lambda v: v-273, "Inlet temperature [Â°C]"),
      ("x3"), 
    ]
    list_for_y_axis = [
      ("response_fn_12", np.log10, "Log 10 (MER) [kg/s]"),
      ("response_fn_4"),
      ("response_fn_11", None, "Exit velocity [m/s]"),
    ]
    ```
  * **Optional parameters:**
    * `n_step` â†’ Sampling step for scatter plot (useful for large datasets). Default: 3.
    * `fig_num` â†’ figure number, useful to create multiple figures.
    * `save_name` â†’ filename (without extension) for saving the figure. If not present, it is auto-generated.
    * `save_dir` â†’ folder where figures are saved. Default: `plot_correlations`.
    * `stats` â†’ dictionary resulting from `bin_and_average()`. If provided, the binned means are plotted.

  Example of usage:
  ```python
  utils.plot_lists(
    dfs={
        "Explosive": df_concat_expl,
        "Effusive": df_concat_eff,
        "Fountaining": df_concat_fount
    },
    x_axis=list_for_x_axis,
    y_axis=list_for_y_axis,
    input_Min=input_Min,
    input_Max=input_Max,
    n_step=1,
    save_name="corrExpEffFount_custom",
    save_dir="plots",
    stats=stats
  )
  ```
  If `save_name` is not provided, the function generates a name like `corr_Explosive_Effusive_Fountaining_my_plot_lists`.



## 5. Sobol Indices (`plot_sobol.py`) 

Plot Sobol sensitivity indices for selected response functions.

```bash
python plot_Sobol.py
```

### Output

Figures are saved in `plot_Sobol/` as 'csv' files.

### Customization

The script can be easily customized to plot different Sobol indices and from different dataframes by modifying the call to `plot_sobol_indices()`.
* `sobol_indices` â†’ dictionary of sobol indices computed by the function `compute_sobol_indices()`.
* **Optional parameters**
  * `xi_labels` â†’ list of strings for the input parameters. 
    Default: `['x1','x2','x3','x4','x5','x6']`
  * `response_labels` â†’ dictionary mapping response function names to descriptive labels.
    Example: `{'response_fn_1': 'Gas volume fraction'}`
  * `save_name` â†’ filename (without extension) used to save the figure as PNG. If not present, it is auto-generated.
  * `save_dir` â†’ folder where the figure is saved. Default: `plot_Sobol`.

Example of usage (with at least 6 input variables):
```python
response_labels = {
    'response_fn_1': 'Gas volume fraction',
    'response_fn_15': 'Fragmentation depth',
    'response_fn_12': 'Mass flow rate',
    'response_fn_4': 'Exit velocity',
    'response_fn_16': 'Exit crystal content',
    'response_fn_28': 'Undercooling @Frag'
}

plot_sobol_indices(
    sobol_indices, 
    xi_labels=['Press.', 'Temp.', 'Radius', 'Hâ‚‚O', 'COâ‚‚', 'Crystals'],
    response_labels=response_labels,
    save_name='sobol_indices',
    save_dir='my_plot_Sobol'
)
```
This call produces a row of stacked bar plots, one for each response function in `response_labels`. Each bar shows the normalized contribution of the input parameters to the variance of the response.

If `save_name` is not provided, the plot is saved as `sobol_indices_my_plot`.

## Notes 

All scripts are designed to be modified by the user to adapt to specific workflows. For example:
- Change the label names going into...

Figures are saved in .svg format for high-quality vector graphics. The user can change it going to...

