# Sensitivity Analysis - Postprocessing  

Scripts to perform the postprocessing of sensitivity analysis results obtained with **DAKOTA** and **MAMMA**.  
This repository provides tools to:  
- Extract and organize raw simulation outputs into `csv` files.  
- Generate correlation plots between input parameters and response functions.  
- Generate plot Sobol indices for variance-based sensitivity analysis.  
- (Planned) Extend functionality to frequency plots and other postprocessing tasks.  

## ðŸ“‘ Table of Contents  

1. [Repository Structure](#1-repository-structure)  
2. [Preparation](#2-preparation)  
3. [Data Extraction (`extact_allData.py`)](#3-data-extraction-extract_alldatapy)  
    * [Usage](#usage)
    * [Output](#output)
    * [Customization](#customization)
4. [Correlation Plots (`plot_correlation.py`)](#4-correlation-plots-plot_correlationpy) 
    * [Input files management](#file-management)
    * [Plotting utilities](#plotting_utilities-1)
    * [Usage](#usage-1)
    * [Output](#output-1)
    * [Customization](#customization-1)
5. [Sobol Indices Plots (`plot_sobol.py`)](#5-sobol-indices-plot_sobolpy)  
    * [Plotting utility](#plotting_utilities-2)
    * [Usage](#usage-2)
    * [Output](#output-2)
    * [Customization](#customization-2)
6. [Histogram Plots (`plot_histograms.py`)](#6-frequency-histograms-plot_historgramspy) 
    * [Plotting utilities](#plotting_utilities-3)
    * [Usage](#usage-3)
    * [Output](#output-3)
    * [Customization](#customization-3)

8. [Notes](#notes) 

##  1. Repository Structure

- **`extract_allData.py`** â†’ Extracts all data from DAKOTA/MAMMA simulations into structured CSV files.  
- **`plot_correlation.py`** â†’ Generates correlation plots between input variables and response functions.  
- **`plot_sobol.py`** â†’ Plots Sobol sensitivity indices.  
- **`plot_histogrmas.py`** â†’ Plots frequency histograms of both input variables and response functions.
- **`plot_frequencies.py`** â†’ Plots frequencies of both input variables and response functions comparing different eruptive styles.
- **`my_lib_extract_data.py`** â†’ Library of functions to support `estract_allData.py'.
- **`my_lib_process_utils.py`** â†’ Library of functions that support all the other scripts.

## 2. Preparation 

Make sure the working directory contains the following files:  

- `dakota_tabular.dat`  
- `dakota_test_parallel.in`  
- `conduit_solver.template`  

Additionally, you need a folder containing all the simulation results from the sensitivity analysis.  
A recommended structure is:  

workdir/

â”œâ”€â”€ workdir.1/

â”œâ”€â”€ workdir.2/

â”œâ”€â”€ ...


## 3. Data Extraction (`extract_allData.py`)

### Usage 
Run the extraction script to collect all simulation results into CSV files:  

```bash
python extract_allData.py

```

Optional arguments:

--verbose true/false â†’ Enable detailed logging.

--pause true/false â†’ Pause execution at key steps.

### Output

The script generates 34 CSV files organized by eruptive style (Explosive, Effusive, Fountaining, etc.) and saves them in the `csv_files/` directory.

Examples:

`data_allConcat.csv`

`data_allConcat_explosive.csv`

`data_allConcat_notExplosive.csv`

`data_allConcat_notExplosive_effusive.csv`

`data_allConcat_notExplosive_fountaining.csv`

â€¦ and others.

Each CSV file uses a *two-row header*:
- **level 0:** technical names (`x1`, `response_fn_12`, â€¦)  
- **level 1:** descriptive labels (`Pressure [Pa]`, `Exit velocity [m/s]`, â€¦)

### Customization 

The user can modify the extraction of data, by adding, removing, or modifying response functions. 
* Go to `extract_allData.py` and modify the part where new response functions are created and where the labels are generated.
  Mind that the current setup accounts for 15 response functions generated by DAKOTA outputs and are read from `dakota_tabular.dat`.
* Go to `my_lib_extract_data.py` and modify inside the functions `extract_data_*`:
  * the part related to `response_data['response_fn_*'][index_simul]`
  * the labels `'response_fn_*': "XXX [YYY]"`,


##  4. Correlation Plots (`plot_correlation.py`)

Generate correlation plots between input parameters (x1, x2, â€¦) and response functions (response_fn_*).

Moreover, the function `bin_and_average` (defined in `my_lib_process_utils.py`) is called to compute binned statistics. The function divides the values â€‹â€‹of the variables `xi` into `N_bins` intervals (bins), and calculates statistics (mean, number of points, sum, min, max) for each `response_fn_*` within each bin. Results are saved, for each regime, in a different dictionary `stats*`.

### Input files management
Checks for required input files  in the `csv_files/` folder and in the current working directory. In the latter case, moves them automatically into the `csv_files/` folder.  

**Mandatory file**  
`dakota_test_parallel.in` (DAKOTA input file containing parameter bounds). 

**Optional files: CSV datasets**  
`data_allConcat.csv`  
`data_allConcat_explosive.csv`  
`data_allConcat_notExplosive.csv`  
`data_allConcat_notExplosive_effusive.csv`  
`data_allConcat_notExplosive_fountaining.csv`  
If these CSV files are not present, they are generated by calling `extract_allData.py`.
All of the above is performed by the function `check_files_required` (defined in `my_lib_process_utils.py`)

Reads CSV files with two-row headers into `pandas.DataFrame` objects.  

### Plotting utilities 
The script comes with two plotting utilities:
  - `plot_xi_vs_response_fn`: plot automatically the correlation of each `xi` present vs. one response function (specified).  
  - `plot_lists`: plot arbitrary pairs of variables.   
  Each plotting utility supports multiple datasets overlayed in the same figure (e.g., Explosive, Effusive, and Fountaining) or a single dataset only.
  In case that multiple datasets are plotted, each one has a distinct color and - if desidered - a distinct marker style.
  Each plotting utility supports the plot of the mean values *IF* a dictionary `stats` is passed.

### Usage 
Run from the terminal:

```bash
python plot_correlation.py
```

### Output
* Plots show scatter distributions and binned means for comparison.
* Multiple eruptive regimes (Explosive, Effusive, Fountaining) can be compared on the same plot.
* Saves figures in `.svg` format under `plot_correlations/`.

### Customization

The script can be easily customized to:

* Change the number of bins (`N_bins`) used to compute the statistics with the function `bin_and_average()`.

* The function `plot_xi_vs_response_fn()` is designed to plot the correlation between all the input parameters (without the need to specify them, because it will automatically look for columns with header `xi`) and a response function. The plot function can be customized by modifying its call.
  * `dfs` â†’ dictionary of datasets to compare.
    Example:

    ```python
    dfs = {
      "Explosive": df_concat_expl,
      "Effusive": df_concat_eff,
      "Fountaining": df_concat_fount
    }
    ```
    
    You can remove some regimes, or pass a single DataFrame instead of a dictionary, like:
    ```python
    dfs = {df_concat}
    ```
  * `response_col` â†’ response function to analyze (e.g. `response_fn_1`, `response_fn_15`).
  * **Optional parameters:**
    * `y_label` â†’ Custom label for Y-axis. Default: the descriptive label from the CSV header.
    * `n_step` â†’ Sampling step for scatter plot (useful for large datasets). Default: 3.
    * `save_name` â†’ Filename (without extension) for saving plot. If not present, it is  auto-generated.
    * `save_dir` â†’ Folder to save plots. Default: `plot_correlations`.
    * `stats` â†’ Dictionary from `bin_and_average()`. If provided, mean values are plotted.

  Example of usage:
  ```python
  plot_xi_vs_response_fn(
    dfs={
        "Explosive": df_concat_expl,
        "notExplosive": df_concat_notExpl
    },
    input_Min=input_Min,
    input_Max=input_Max,
    response_col='response_fn_1',
    n_step=2,
    save_name='my_plot',
    save_dir='plots',
    stats=stats
  )
  ```
  If `save_name` is not provided, the function generates a name like `corr_Explosive_notExplosive_xi_response_fn_1`.


* The function `plot_list()` is designed to plot the correlation between arbitrary pairs of variables, defined by two lists. It is very flexible: the user can specify transformations, labels, and multiple datasets to overlay in the same figure.
  * `dfs` â†’ dictionary of datasets to compare.
    Example:

    ```python
    dfs = {
      "Explosive": df_concat_expl,
      "Effusive": df_concat_eff,
      "Fountaining": df_concat_fount
    }
    ```
    
    You can remove some regimes, or pass a single DataFrame instead of a dictionary, like:
    ```python
    dfs = {df_concat}
    ```
  * `x_axis`, `y_axis` â†’ lists of tuples defining what to plot. Each tuple can have up to 3 elements: 
    * `col_name` â†’ column name in the DataFrame (e.g., `'x1'` or `'response_fn_4'`)
    * `transform_or_factor` â†’ (optional) function (e.g., sum, multiplication, log10) applied to the data
    * `label` â†’ () string for axis label

    Example of how to create the two lists:
    ```python
    list_for_x_axis = [
      ("x1", lambda v: v/1e6, "Inlet pressure [MPa]"),
      ("x2", lambda v: v-273, "Inlet temperature [Â°C]"),
      ("x3"), 
    ]
    list_for_y_axis = [
      ("response_fn_12", np.log10, "Log 10 (MER) [kg/s]"),
      ("response_fn_4"),
      ("response_fn_11", None, "Exit velocity [m/s]"),
    ]
    ```
  * **Optional parameters:**
    * `n_step` â†’ Sampling step for scatter plot (useful for large datasets). Default: 3.
    * `fig_num` â†’ figure number, useful to create multiple figures.
    * `save_name` â†’ filename (without extension) for saving the figure. If not present, it is auto-generated.
    * `save_dir` â†’ folder where figures are saved. Default: `plot_correlations`.
    * `stats` â†’ dictionary resulting from `bin_and_average()`. If provided, the binned means are plotted.

  Example of usage:
  ```python
  plot_lists(
    dfs={
        "Explosive": df_concat_expl,
        "Effusive": df_concat_eff,
        "Fountaining": df_concat_fount
    },
    x_axis=list_for_x_axis,
    y_axis=list_for_y_axis,
    input_Min=input_Min,
    input_Max=input_Max,
    n_step=1,
    save_name="corrExpEffFount_custom",
    save_dir="plots",
    stats=stats
  )
  ```
  If `save_name` is not provided, the function generates a name like `corr_Explosive_Effusive_Fountaining_my_plot_lists`.



## 5. Sobol Indices (`plot_sobol.py`) 

Plot Sobol sensitivity indices for selected response functions.

Moreover, the function `bin_and_average` (defined in `my_lib_process_utils.py`) is called to compute binned statistics. The function divides the values â€‹â€‹of the variables `xi` into `N_bins` intervals (bins), and calculates statistics (mean, number of points, sum, min, max) for each `response_fn_*` within each bin. Results are saved, for each regime, in a different dictionary `stats*`.

Results `stats*` of `bin_and_average` are passed to the function `compute_sobol_indices` that calculate the sobol indices for all the variables. Results are saved, for each regime, in a different dictionary `sobol_indices*`.

Same files management described in [Input files management](#file-management).

### Plotting utility
The script presents one plot utility:
- `plot_sobol_indices`: plot the sobol indices `sobol_indices*` of all variables or of a selection of variables.

### Usage

```bash
python plot_Sobol.py
```

### Output

Figures are saved in `plot_Sobol/` as 'svg' files.

### Customization

The script can be easily customized to plot different Sobol indices and from different dataframes by modifying the call to `plot_sobol_indices()`.
* `sobol_indices` â†’ dictionary of sobol indices computed by the function `compute_sobol_indices()`.
* **Optional parameters**
  * `xi_labels` â†’ list of strings for the input parameters. Must have the same length as the number of xi insobol_indices. 
    If not provided, labels are automatically generated as `['x1','x2',â€¦,'xN']` where `N` is the number of input parameters.
  * `response_labels` â†’ dictionary mapping response function names to descriptive labels.
    Example: `{'response_fn_1': 'Gas volume fraction'}`
  * `save_name` â†’ filename (without extension). 
    If not present, the default name is `sobol_indices_my_plot`.
  * `save_dir` â†’ folder where the figure is saved. Default: `plot_Sobol`.

Example of usage:
```python
response_labels = {
    'response_fn_1': 'Gas volume fraction',
    'response_fn_15': 'Fragmentation depth',
    'response_fn_12': 'Mass flow rate',
    'response_fn_4': 'Exit velocity',
    'response_fn_16': 'Exit crystal content',
    'response_fn_28': 'Undercooling @Frag'
}

plot_sobol_indices(
    sobol_indices, 
    xi_labels=['Press.', 'Temp.', 'Radius', 'Hâ‚‚O', 'COâ‚‚', 'Crystals'],
    response_labels=response_labels,
    save_name='sobol_indices',
    save_dir='my_plot_Sobol'
)
```
This call produces a row of stacked bar plots, one for each response function in `response_labels`. Each bar shows the normalized contribution of the input parameters to the variance of the response.

If `save_name` is not provided, the plot is saved as `plot_Sobol`.

## 6. Frequency histograms (`plot_histograms.py`)
Plot frequency histograms for input parameters `x*` and selcted response functions `response_fn_*`.

Same files management described in [Input files management](#file-management).

### Plotting utilities
The script comes with two plotting utilities:
- `plot_xi_histograms`: plot automatically the frequency histogram of each input variable `xi` available, or just a selection of them if specified.
- `plot_histogram_lists`: generic function that plot histograms of a list of variables (can be both `xi` and `response_fn_i`).
These functions accept just one dataset (differently from other plotting utilities present in this package).

### Usage
Run from the terminal:
```bash
python plot_histograms.py
```


### Output
Figures are saved in the folder `plot_histograms/` as `svg` files.
Each figure corresponds to a specific simulation group (e.g., All simulations, Explosive, Effusive, etc.) and variable set.

### Customization
The script can be easily customized to plot histograms of different variables and from different dataframes by modifying the calls to `plot_xi_histograms(...)` and `plot_histogram_lists(...)`.

* Change the number of bins (`bins`) used to create the histograms.

* The function `plot_xi_histograms()` is designed to plot histograms for all the input parameters without the need to specify them (because it will automatically look for columns with header `xi`) or only a selection of them. The plot function can be customized by modifying its call.
  * `df` â†’ dictionary of datasets or simple dataset.
    Example:

    ```python
    df = {"Explosive": df_concat_expl}
    ```
    
    You can pass directly the DataFrame instead of a dictionary, like:
    ```python
    dfs = {df_concat}
    ```
  * `response_col` â†’ response function to analyze (e.g. `response_fn_1`, `response_fn_15`).
  * **Optional parameters:**
    * `y_label` â†’ Custom label for Y-axis. Default: the descriptive label from the CSV header.
    * `n_step` â†’ Sampling step for scatter plot (useful for large datasets). Default: 3.
    * `save_name` â†’ Filename (without extension) for saving plot. If not present, it is  auto-generated.
    * `save_dir` â†’ Folder to save plots. Default: `plot_correlations`.
    * `stats` â†’ Dictionary from `bin_and_average()`. If provided, mean values are plotted.

  Example of usage:
  ```python
  utils.plot_xi_vs_response_fn(
    dfs={
        "Explosive": df_concat_expl,
        "notExplosive": df_concat_notExpl
    },
    input_Min=input_Min,
    input_Max=input_Max,
    response_col='response_fn_1',
    n_step=2,
    save_name='my_plot',
    save_dir='plots',
    stats=stats
  )
  ```
  If `save_name` is not provided, the function generates a name like `corr_Explosive_notExplosive_xi_response_fn_1`.





Example of usage:
```python
response_labels = {
    'response_fn_1': 'Gas volume fraction',
    'response_fn_15': 'Fragmentation depth',
    'response_fn_12': 'Mass flow rate',
    'response_fn_4': 'Exit velocity',
    'response_fn_16': 'Exit crystal content',
    'response_fn_28': 'Undercooling @Frag'
}

plot_sobol_indices(
    sobol_indices, 
    xi_labels=['Press.', 'Temp.', 'Radius', 'Hâ‚‚O', 'COâ‚‚', 'Crystals'],
    response_labels=response_labels,
    save_name='sobol_indices',
    save_dir='my_plot_Sobol'
)
```
This call produces a row of stacked bar plots, one for each response function in `response_labels`. Each bar shows the normalized contribution of the input parameters to the variance of the response.

If `save_name` is not provided, the plot is saved as `plot_Sobol`.


## Notes 

All scripts are designed to be modified by the user to adapt to specific workflows. For example:
- Change the label names going into...

Figures are saved in .svg format for high-quality vector graphics. The user can change it going to...

